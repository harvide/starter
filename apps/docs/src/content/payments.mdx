# Payment Integration

Harvide Starter supports multiple payment providers through Better Auth's payment plugins. Current supported providers:
- Polar - Developer-first payment infrastructure
- Stripe - Global payment platform

## Configuration

Payment settings are managed through the `starter.config.ts` file:

```typescript
export default {
  payments: {
    enabled: true,
    provider: {
      name: 'polar', // or 'stripe'
      // Polar-specific configuration
      polar: {
        environment: 'sandbox', // or 'production'
        features: {
          subscription: true,
          usage: true,
          portal: true,
          discounts: false
        }
      },
      // Stripe-specific configuration
      stripe: {
        features: {
          subscription: true,
          teamBilling: true,
          trial: true
        }
      }
    },
    // Common settings
    createCustomerOnSignUp: true,
    subscription: {
      enabled: true,
      plans: [
        {
          name: 'starter',
          priceId: 'price_id',
          trial: {
            days: 14,
            requireCard: false
          }
        },
        {
          name: 'pro',
          priceId: 'price_id'
        }
      ]
    },
    usage: {
      enabled: true,
      meters: [
        {
          name: 'api-calls',
          unit: 'call'
        }
      ]
    },
    portal: {
      enabled: true,
      returnUrl: '/dashboard'
    }
  }
}
```

## Environment Variables

Each provider requires its own set of environment variables:

```env
# Polar
POLAR_ACCESS_TOKEN=your_access_token
POLAR_WEBHOOK_SECRET=your_webhook_secret

# Stripe
STRIPE_SECRET_KEY=your_secret_key
STRIPE_WEBHOOK_SECRET=your_webhook_secret
```

## Polar Integration

### Features

- Checkout Integration
- Customer Portal
- Automatic Customer creation on signup
- Event Ingestion & Customer Meters for Usage Based Billing
- Secure Webhook Handling
- Organization Support for Team Billing

### Client-Side Usage

```typescript
import { authClient } from '@repo/auth/client';

// Initialize a checkout session
await authClient.checkout({
  products: ['product-id'],  // Use product ID directly
  slug: 'pro'               // Or use plan slug from config
});

// Access customer portal
await authClient.customer.portal();

// Get customer state
const { data: customerState } = await authClient.customer.state();

// List customer benefits
const { data: benefits } = await authClient.customer.benefits.list({
  query: { page: 1, limit: 10 }
});

// List customer orders
const { data: orders } = await authClient.customer.orders.list({
  query: { page: 1, limit: 10 }
});

// List customer subscriptions
const { data: subscriptions } = await authClient.customer.subscriptions.list({
  query: { page: 1, limit: 10, active: true }
});
```

### Organization Support

```typescript
// Get organization ID
const organizationId = (await authClient.organization.list())?.data?[0]?.id;

// Create checkout with organization reference
await authClient.checkout({
  products: ['product-id'],
  referenceId: organizationId  // Links purchase to organization
});

// List subscriptions for organization
const { data: orgSubscriptions } = await authClient.customer.subscriptions.list({
  query: {
    page: 1,
    limit: 10,
    active: true,
    referenceId: organizationId
  }
});
```

### Usage Based Billing

```typescript
// Record usage event
const { data: ingested } = await authClient.usage.ingest({
  event: 'api-calls',
  metadata: {
    count: 1
  }
});

// Get customer meters
const { data: customerMeters } = await authClient.usage.meters.list({
  query: { page: 1, limit: 10 }
});
```

For more details, visit the [Polar documentation](https://www.polar.sh/docs).

## Stripe Integration

### Features

- Automatic customer creation on signup
- Subscription management with plans and pricing
- Processing subscription lifecycle events
- Secure webhook handling
- Team subscription support with seats management
- Trial periods and subscription upgrades

### Client-Side Usage

```typescript
import { authClient } from '@repo/auth/client';

// Create a subscription
await authClient.subscription.upgrade({
  plan: "pro",
  successUrl: "/dashboard",
  cancelUrl: "/pricing",
  annual: true          // Optional: upgrade to annual plan
});

// Cancel subscription
await authClient.subscription.cancel({
  returnUrl: "/account"
});

// Restore cancelled subscription
await authClient.subscription.restore();

// List active subscriptions
const { data: subscriptions } = await authClient.subscription.list();
```

### Organization Support

```typescript
// Get organization ID
const organizationId = (await authClient.organization.list())?.data?[0]?.id;

// Create subscription with organization reference
await authClient.subscription.upgrade({
  plan: "team",
  referenceId: organizationId,  // Links subscription to organization
  seats: 5,                     // Number of team member seats
  successUrl: "/org/billing/success",
  cancelUrl: "/org/billing"
});

// List subscriptions for organization
const { data: orgSubscriptions } = await authClient.subscription.list({
  query: {
    referenceId: organizationId,
    active: true
  }
});
```

### Trial Periods

```typescript
// Start a trial subscription
await authClient.subscription.upgrade({
  plan: "pro",
  trial: {
    days: 14,
    requireCard: false
  },
  successUrl: "/dashboard",
  cancelUrl: "/pricing"
});
```

For more details, visit the [Better Auth Stripe plugin documentation](https://www.better-auth.com/docs/plugins/stripe).
